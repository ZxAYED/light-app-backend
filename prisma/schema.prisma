generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String               @id @default(uuid())
  email                  String               @unique
  password               String
  role                   UserRole             @default(PARENT)
  createdAt              DateTime             @default(now())
  otp                    String?
  isDeleted              Boolean?             @default(false)
  otp_expires_at         DateTime?
  is_verified            Boolean              @default(false)
  password_reset_otp     String?
  password_reset_expires DateTime?
  auditLogs              AuditLog[]
  childProfile           ChildProfile?
  goalsAuthored          Goal[]
  HelpRequest            HelpRequest[]
  HelpRequestMessage     HelpRequestMessage[]
  Notification           Notification[]
  parentProfile          ParentProfile?
  PushToken              PushToken[]

  @@index([role])
}

model ParentProfile {
  id          String    @id @default(uuid())
  userId      String    @unique
  name        String
  phone       String
  image       String?
  imagePath   String?
  relation    Relation?
  dateOfBirth DateTime?
  location    String?
  isDeleted   Boolean?  @default(false)

  giftedCoins      Int?           @default(0)
  pushNotification Boolean?       @default(true)
  dailyReminders   Boolean?       @default(true)
  childTaskUpdates Boolean?       @default(true)
  children         ChildProfile[]
  user             User           @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([name])
}

model ChildProfile {
  id               String            @id @default(uuid())
  userId           String            @unique
  parentId         String
  accountType      ChildAccountType  @default(MODERATOR)
  name             String
  gender           Gender?
  phone            String?
  email            String?
  dateOfBirth      DateTime?
  location         String?
  image            String?
  imagePath        String?
  coins            Int               @default(0)
  relation         String?
  editProfile      Boolean           @default(true)
  createGoals      Boolean           @default(true)
  approveTasks     Boolean           @default(true)
  deleteGoals      Boolean           @default(false)
  deleteAccount    Boolean           @default(false)
  avatarId         String?
  isDeleted        Boolean?          @default(false)
  auditLogs        AuditLog[]
  ChildAsset       ChildAsset[]
  avatar           Avatar?           @relation(fields: [avatarId], references: [id])
  parent           ParentProfile     @relation(fields: [parentId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  goals            GoalAssignment[]
  HelpRequest      HelpRequest[]
  Notification     Notification[]
  PushToken        PushToken[]
  goalProgressLogs GoalProgressLog[]

  @@index([parentId])
  @@index([userId])
  @@index([name])
}

model Goal {
  id          String     @id @default(uuid())
  authorId    String
  authorRole  AuthorRole @default(PARENT)
  title       String
  description String?
  type        GoalType   @default(ONE_TIME)
  status      GoalStatus @default(ACTIVE)
  rewardCoins Int        @default(0)
  startDate   DateTime?
  endDate     DateTime?
  durationMin Int?
  progress    Int?       @default(0)
  progressAvg Int?       @default(0)
  createdAt   DateTime   @default(now())
  isDeleted   Boolean    @default(false)
  isRecurring Boolean?   @default(false)
  nextResetAt DateTime?

  author           User              @relation(fields: [authorId], references: [id])
  assignedChildren GoalAssignment[]
  HelpRequest      HelpRequest[]
  Notification     Notification[]
  goalProgressLogs GoalProgressLog[]

  @@index([authorId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([title])
}

model GoalAssignment {
  id      String @id @default(uuid())
  goalId  String
  childId String

  minutesCompleted Int? @default(0) 
 progressAvg Int? @default(0)


  percentage    Int?      @default(0)
  lastResetAt   DateTime? 
lastUpdatedAt DateTime? @default(now()) @db.Timestamptz(6)


  isDeleted Boolean      @default(false)
  child     ChildProfile @relation(fields: [childId], references: [id])
  goal      Goal         @relation(fields: [goalId], references: [id])

  @@unique([goalId, childId])
  @@index([goalId])
  @@index([childId])
}

model GoalProgressLog {
  id        String   @id @default(uuid())
  goalId    String
  childId   String
  minutes   Int
  percent   Int
  createdAt DateTime @default(now())

  goal  Goal         @relation(fields: [goalId], references: [id])
  child ChildProfile @relation(fields: [childId], references: [id])

  @@index([goalId])
  @@index([childId])
}

model Notification {
  id            String           @id @default(uuid())
  parentId      String?
  childId       String?
  goalId        String?
  helpRequestId String?
  assetId       String?
  type          NotificationType
  title         String
  message       String
  isRead        Boolean          @default(false)
  createdAt     DateTime         @default(now())
  asset         Asset?           @relation(fields: [assetId], references: [id])
  child         ChildProfile?    @relation(fields: [childId], references: [id])
  goal          Goal?            @relation(fields: [goalId], references: [id])
  helpRequest   HelpRequest?     @relation(fields: [helpRequestId], references: [id])
  parent        User?            @relation(fields: [parentId], references: [id])
}

model HelpRequest {
  id            String               @id @default(uuid())
  childId       String
  parentId      String
  goalId        String
  message       String?
  status        HelpStatus           @default(PENDING)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  child         ChildProfile         @relation(fields: [childId], references: [id])
  goal          Goal                 @relation(fields: [goalId], references: [id])
  parent        User                 @relation(fields: [parentId], references: [id])
  replies       HelpRequestMessage[]
  notifications Notification[]
}

model HelpRequestMessage {
  id            String      @id @default(uuid())
  helpRequestId String
  senderId      String
  senderRole    UserRole
  message       String
  createdAt     DateTime    @default(now())
  helpRequest   HelpRequest @relation(fields: [helpRequestId], references: [id])
  sender        User        @relation(fields: [senderId], references: [id])

  @@index([helpRequestId])
  @@index([senderId])
}

model ChildAsset {
  id        String       @id @default(uuid())
  childId   String
  assetId   String
  createdAt DateTime     @default(now())
  asset     Asset        @relation(fields: [assetId], references: [id])
  child     ChildProfile @relation(fields: [childId], references: [id])

  @@unique([childId, assetId])
}

model Asset {
  id           String         @id @default(uuid())
  name         String
  category     AssetCategory
  style        String?
  colorName    String?
  image        String
  imagePath    String?
  price        Int
  origin       String?
  gender       AssetGender?
  avatarId     String?
  createdAt    DateTime       @default(now())
  avatar       Avatar?        @relation(fields: [avatarId], references: [id])
  unlockedBy   ChildAsset[]
  Notification Notification[]
}

model Avatar {
  id        String         @id @default(uuid())
  name      String
  image     String
  origin    String?
  gender    AvatarGender
  createdAt DateTime       @default(now())
  assets    Asset[]
  usedBy    ChildProfile[]
}

model PushToken {
  id        String        @id @default(uuid())
  userId    String?
  childId   String?
  token     String        @unique
  platform  Platform
  createdAt DateTime      @default(now())
  child     ChildProfile? @relation(fields: [childId], references: [id])
  user      User?         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([childId])
}

model AuditLog {
  id        String        @id @default(uuid())
  userId    String?
  childId   String?
  action    String
  metadata  Json?
  createdAt DateTime      @default(now())
  child     ChildProfile? @relation(fields: [childId], references: [id])
  user      User?         @relation(fields: [userId], references: [id])
}

enum UserRole {
  PARENT
  CHILD
  ADMIN
}

enum Relation {
  FATHER
  MOTHER
  BROTHER
  SISTER
}

enum Gender {
  MALE
  FEMALE
}

enum ChildAccountType {
  ADMIN
  MODERATOR
  VIEWER
}

enum AuthorRole {
  PARENT
  CHILD
}

enum GoalStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum GoalType {
  ONE_TIME
  DAILY
  WEEKLY
  MONTHLY
}

enum NotificationType {
  GOAL_CREATED
  GOAL_UPDATED
  GOAL_COMPLETED
  HELP_REQUEST
  HELP_REQUEST_ACCEPTED
  HELP_REQUEST_REJECTED
  REWARD_UNLOCKED
  DAILY_REMINDER
  CHILD_PROGRESS_UPDATE
}

enum HelpStatus {
  PENDING
  ACTIVE
  RESOLVED
  CLOSED
}

enum AssetCategory {
  SKIN
  HAIR
  EYES
  NOSE
  DRESS
  SHOES
  ACCESSORY
  JEWELRY
  PET
  AVATAR_BASE
}

enum AssetGender {
  MALE
  FEMALE
  UNISEX
}

enum AvatarGender {
  MALE
  FEMALE
}

enum Platform {
  ANDROID
  IOS
}
