generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String               @id @default(uuid())
  email                  String               @unique
  password               String
  name                   String?
  role                   UserRole             @default(PARENT)
  createdAt              DateTime             @default(now())
  otp                    String?
  isDeleted              Boolean?             @default(false)
  otp_expires_at         DateTime?
  is_verified            Boolean              @default(false)
  password_reset_otp     String?
  password_reset_expires DateTime?
  auditLogs              AuditLog[]
  childProfile           ChildProfile?
  goalsAuthored          Goal[]
  HelpRequest            HelpRequest[]
  HelpRequestMessage     HelpRequestMessage[]
  Notification           Notification[]
  parentProfile          ParentProfile?
  PushToken              PushToken[]

  @@index([role])
}

model ParentProfile {
  id          String    @id @default(uuid())
  userId      String    @unique
  name        String
  phone       String
  image       String?
  imagePath   String?
  relation    Relation?
  dateOfBirth DateTime?
  location    String?
  isDeleted   Boolean?  @default(false)

  giftedCoins      Int?           @default(0)
  pushNotification Boolean?       @default(true)
  dailyReminders   Boolean?       @default(true)
  childTaskUpdates Boolean?       @default(true)
  children         ChildProfile[]
  user             User           @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([name])
}

model ChildProfile {
  id               String            @id @default(uuid())
  userId           String            @unique
  parentId         String
  accountType      ChildAccountType  @default(MODERATOR)
  name             String
  gender           Gender?
  phone            String?
  email            String?
  dateOfBirth      DateTime?
  location         String?
  image            String?
  imagePath        String?
  completedTask    Int?           @default(0)
  coins            Int               @default(0)
  relation         String?
  editProfile      Boolean           @default(true)
  createGoals      Boolean           @default(true)
  approveTasks     Boolean           @default(true)
  deleteGoals      Boolean           @default(false)
  deleteAccount    Boolean           @default(false)
  avatarId         String?
  isDeleted        Boolean?          @default(false)
  auditLogs        AuditLog[]
  ChildAsset       ChildAsset[]
  avatar           Avatar?           @relation(fields: [avatarId], references: [id])
  parent           ParentProfile     @relation(fields: [parentId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  goals            GoalAssignment[]
  HelpRequest      HelpRequest[]
  Notification     Notification[]
  PushToken        PushToken[]
  goalProgressLogs GoalProgressLog[]
  childAvatars     ChildAvatar[]

  @@index([parentId])
  @@index([userId])
  @@index([name])
}

model Goal {
  id          String     @id @default(uuid())
  authorId    String
  authorRole  AuthorRole @default(PARENT)
  title       String
  description String?
  type        GoalType   @default(ONE_TIME)
  status      GoalStatus @default(ACTIVE)
  rewardCoins Int        @default(0)
  startDate   DateTime?
  endDate     DateTime?
  durationMin Int?
  progress    Int?       @default(0)
  progressAvg Int?       @default(0)
  createdAt   DateTime   @default(now())
  isDeleted   Boolean    @default(false)
  isRecurring Boolean?   @default(false)
  nextResetAt DateTime?

  author           User              @relation(fields: [authorId], references: [id])
  assignedChildren GoalAssignment[]
  HelpRequest      HelpRequest[]
  Notification     Notification[]
  goalProgressLogs GoalProgressLog[]

  @@index([authorId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([title])
}

model GoalAssignment {
  id      String @id @default(uuid())
  goalId  String
  childId String

  minutesCompleted Int? @default(0)
  progressAvg      Int? @default(0)

  percentage    Int?      @default(0)
  lastResetAt   DateTime?
  lastUpdatedAt DateTime? @default(now()) @db.Timestamptz(6)

  isDeleted Boolean      @default(false)
  child     ChildProfile @relation(fields: [childId], references: [id])
  goal      Goal         @relation(fields: [goalId], references: [id])

  @@unique([goalId, childId])
  @@index([goalId])
  @@index([childId])
}

model GoalProgressLog {
  id        String   @id @default(uuid())
  goalId    String
  childId   String
  minutes   Int
  percent   Int
  createdAt DateTime @default(now())

  goal  Goal         @relation(fields: [goalId], references: [id])
  child ChildProfile @relation(fields: [childId], references: [id])

  @@index([goalId])
  @@index([childId])
}

model Notification {
  id            String           @id @default(uuid())
  parentId      String?
  childId       String?
  goalId        String?
  helpRequestId String?
  assetId       String?
  type          NotificationType
  title         String
  message       String
  isRead        Boolean          @default(false)
  createdAt     DateTime         @default(now())
  asset         Asset?           @relation(fields: [assetId], references: [id])
  child         ChildProfile?    @relation(fields: [childId], references: [id])
  goal          Goal?            @relation(fields: [goalId], references: [id])
  helpRequest   HelpRequest?     @relation(fields: [helpRequestId], references: [id])
  parent        User?            @relation(fields: [parentId], references: [id])
}

model HelpRequest {
  id            String               @id @default(uuid())
  childId       String
  parentId      String
  goalId        String
  message       String?
  status        HelpStatus           @default(PENDING)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  child         ChildProfile         @relation(fields: [childId], references: [id])
  goal          Goal                 @relation(fields: [goalId], references: [id])
  parent        User                 @relation(fields: [parentId], references: [id])
  replies       HelpRequestMessage[]
  notifications Notification[]
}

model HelpRequestMessage {
  id            String      @id @default(uuid())
  helpRequestId String
  senderId      String
  senderRole    UserRole
  message       String
  createdAt     DateTime    @default(now())
  helpRequest   HelpRequest @relation(fields: [helpRequestId], references: [id])
  sender        User        @relation(fields: [senderId], references: [id])

  @@index([helpRequestId])
  @@index([senderId])
}

enum AvatarGender {
  MALE
  FEMALE
}

enum AssetCategory {
  HAIR
  DRESS
  JEWELRY
  EYES
  SKIN
  NOSE
  SHOES
  ACCESSORY
  PET
  AVATAR_BASE
  FACE
}

enum AssetGender {
  MALE
  FEMALE
  UNISEX
}

enum Rarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

model Avatar {
  id            String       @id @default(uuid())
  avatarImgUrl  String?
  avatarImgPath String?
  gender        AvatarGender

  region        String?
  description   String?
  purchased     Int?             @default(0)
  price         Int?             @default(0)
  createdAt     DateTime         @default(now())
  categories    AvatarCategory[]
  ownerships    ChildAvatar[]
  childProfiles ChildProfile[]

  @@index([gender])
  @@index([region])
}

model AvatarCategory {
  id          String             @id @default(uuid())
  avatarId    String
  type        AvatarCategoryType
  avatar      Avatar             @relation(fields: [avatarId], references: [id])
  assetStyles AssetStyle[]

  @@unique([avatarId, type])
}

enum AvatarCategoryType {
  SKIN
  HAIR
  EYES
  NOSE
  DRESS
  SHOES
  ACCESSORY
  JEWELRY
  PET
}

model AssetStyle {
  id          String  @id @default(uuid())
  categoryId  String
  styleName   String
  description String?

  createdAt DateTime @default(now())

  category AvatarCategory @relation(fields: [categoryId], references: [id])
  colors   Asset[]

  @@index([categoryId])
  @@index([styleName])
}

model Asset {
  id           String       @id @default(uuid())
  styleId      String
  assetImage   String
  assetImgPath String?
  colorName    String?
  description  String?
  gender       AssetGender?
  price        Int          @default(0)
  rarity       Rarity?      @default(COMMON)
  isStarter    Boolean      @default(false)
  purchased    Int?         @default(0)
  createdAt    DateTime     @default(now())

  style         AssetStyle     @relation(fields: [styleId], references: [id])
  unlocked      ChildAsset[]
  notifications Notification[]
}

model ChildAsset {
  id        String   @id @default(uuid())
  childId   String
  assetId   String
  createdAt DateTime @default(now())

  child ChildProfile @relation(fields: [childId], references: [id])
  asset Asset        @relation(fields: [assetId], references: [id])

  @@unique([childId, assetId])
}

model ChildAvatar {
  id         String   @id @default(uuid())
  childId    String
  avatarId   String
  isActive   Boolean  @default(false)
  unlockedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  child  ChildProfile @relation(fields: [childId], references: [id])
  avatar Avatar       @relation(fields: [avatarId], references: [id])

  @@unique([childId, avatarId])
}

model PushToken {
  id        String        @id @default(uuid())
  userId    String?
  childId   String?
  token     String        @unique
  platform  Platform
  createdAt DateTime      @default(now())
  child     ChildProfile? @relation(fields: [childId], references: [id])
  user      User?         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([childId])
}

model AuditLog {
  id        String        @id @default(uuid())
  userId    String?
  childId   String?
  action    String
  metadata  Json?
  createdAt DateTime      @default(now())
  child     ChildProfile? @relation(fields: [childId], references: [id])
  user      User?         @relation(fields: [userId], references: [id])
}

enum UserRole {
  PARENT
  CHILD
  ADMIN
}

enum Relation {
  FATHER
  MOTHER
  BROTHER
  SISTER
}

enum Gender {
  MALE
  FEMALE
}

enum ChildAccountType {
  ADMIN
  MODERATOR
  VIEWER
}

enum AuthorRole {
  PARENT
  CHILD
}

enum GoalStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum GoalType {
  ONE_TIME
  DAILY
  WEEKLY
  MONTHLY
}

enum NotificationType {
  GOAL_CREATED
  GOAL_UPDATED
  GOAL_COMPLETED
  HELP_REQUEST
  HELP_REQUEST_ACCEPTED
  HELP_REQUEST_REJECTED
  REWARD_UNLOCKED
  DAILY_REMINDER
  CHILD_PROGRESS_UPDATE
}

enum HelpStatus {
  PENDING
  ACTIVE
  RESOLVED
  CLOSED
}

enum Platform {
  ANDROID
  IOS
}
