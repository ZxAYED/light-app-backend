generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      UserRole @default(PARENT)
  createdAt DateTime @default(now())

  goalsAuthored      Goal[]
  parentProfile      ParentProfile?
  childProfile       ChildProfile?
  Notification       Notification[]
  HelpRequest        HelpRequest[]
  HelpRequestMessage HelpRequestMessage[]
  PushToken          PushToken[]
  auditLogs          AuditLog[]

  @@index([role])
}

enum UserRole {
  PARENT
  CHILD
  ADMIN
}

model ParentProfile {
  id     String @id @default(uuid())
  userId String @unique

  name        String
  phone       String
  image       String
  gender      Gender?
  dateOfBirth DateTime?
  location    String?
  giftedCoins Int?      @default(0)

  pushNotification Boolean? @default(true)
  dailyReminders   Boolean? @default(true)
  childTaskUpdates Boolean? @default(true)

  user     User           @relation(fields: [userId], references: [id])
  children ChildProfile[]

  @@index([userId])
  @@index([name]) // Parent searching by name
}

model ChildProfile {
  id       String @id @default(uuid())
  userId   String @unique
  parentId String

  accountType ChildAccountType @default(MODERATOR)
  name        String
  gender      Gender?
  phone       String?
  email       String?
  dateOfBirth DateTime?
  location    String?
  image       String

  coins    Int     @default(0)
  relation String?

  editProfile   Boolean @default(true)
  createGoals   Boolean @default(true)
  approveTasks  Boolean @default(true)
  deleteGoals   Boolean @default(false)
  deleteAccount Boolean @default(false)

  goals        GoalAssignment[]
  parent       ParentProfile    @relation(fields: [parentId], references: [id])
  user         User             @relation(fields: [userId], references: [id])
  avatarId     String?
  avatar       Avatar?          @relation(fields: [avatarId], references: [id])
  Notification Notification[]
  HelpRequest  HelpRequest[]
  ChildAsset   ChildAsset[]
  PushToken    PushToken[]
  auditLogs    AuditLog[]

  @@index([parentId]) // Fetch children for parent quickly
  @@index([name]) // Useful for searching child by name
}

enum Gender {
  MALE
  FEMALE
}

enum ChildAccountType {
  ADMIN
  MODERATOR
  VIEWER
}

model Goal {
  id         String     @id @default(uuid())
  authorId   String
  authorRole AuthorRole @default(PARENT)

  title       String
  description String?
  type        GoalType   @default(ONE_TIME)
  status      GoalStatus @default(ACTIVE)
  rewardCoins Int        @default(0)
  startDate   DateTime?
  endDate     DateTime?
  durationMin Int?
  progress    Int        @default(0)
  createdAt   DateTime   @default(now())

  author           User             @relation(fields: [authorId], references: [id])
  assignedChildren GoalAssignment[]
  Notification     Notification[]
  HelpRequest      HelpRequest[]

  // ðŸ”¥ Indexes for fast filtering & searching
  @@index([authorId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([title])
}

model GoalAssignment {
  id      String @id @default(uuid())
  goalId  String
  childId String

  goal  Goal         @relation(fields: [goalId], references: [id])
  child ChildProfile @relation(fields: [childId], references: [id])

  @@unique([goalId, childId])
  @@index([goalId])
  @@index([childId])
}

enum AuthorRole {
  PARENT
  CHILD
}

enum GoalStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum GoalType {
  ONE_TIME
  DAILY
  WEEKLY
  MONTHLY
}

model Notification {
  id            String  @id @default(uuid())
  parentId      String?
  childId       String?
  goalId        String?
  helpRequestId String?
  assetId       String?

  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  parent      User?         @relation(fields: [parentId], references: [id])
  child       ChildProfile? @relation(fields: [childId], references: [id])
  goal        Goal?         @relation(fields: [goalId], references: [id])
  helpRequest HelpRequest?  @relation(fields: [helpRequestId], references: [id])
  asset       Asset?        @relation(fields: [assetId], references: [id])
}

enum NotificationType {
  GOAL_CREATED
  GOAL_UPDATED
  GOAL_COMPLETED

  HELP_REQUEST
  HELP_REQUEST_ACCEPTED
  HELP_REQUEST_REJECTED

  REWARD_UNLOCKED

  DAILY_REMINDER
  CHILD_PROGRESS_UPDATE
}

model HelpRequest {
  id       String @id @default(uuid())
  childId  String
  parentId String
  goalId   String

  message String? // initial message from child
  status  HelpStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  child  ChildProfile @relation(fields: [childId], references: [id])
  parent User         @relation(fields: [parentId], references: [id])
  goal   Goal         @relation(fields: [goalId], references: [id])

  replies       HelpRequestMessage[]
  notifications Notification[]
}

model HelpRequestMessage {
  id            String   @id @default(uuid())
  helpRequestId String
  senderId      String
  senderRole    UserRole
  message       String
  createdAt     DateTime @default(now())

  helpRequest HelpRequest @relation(fields: [helpRequestId], references: [id])
  sender      User        @relation(fields: [senderId], references: [id])

  @@index([helpRequestId])
  @@index([senderId])
}

enum HelpStatus {
  PENDING
  ACTIVE
  RESOLVED
  CLOSED
}

enum AssetCategory {
  SKIN
  HAIR
  EYES
  NOSE
  DRESS
  SHOES
  ACCESSORY
  JEWELRY
  PET
  AVATAR_BASE
}

enum AssetGender {
  MALE
  FEMALE
  UNISEX
}

model ChildAsset {
  id        String   @id @default(uuid())
  childId   String
  assetId   String
  createdAt DateTime @default(now())

  child ChildProfile @relation(fields: [childId], references: [id])
  asset Asset        @relation(fields: [assetId], references: [id])

  @@unique([childId, assetId])
}

enum AvatarGender {
  MALE
  FEMALE
}

model Asset {
  id        String        @id @default(uuid())
  name      String
  category  AssetCategory
  style     String? // e.g., "Long", "Curly", "Basic", "Style 1"
  colorName String? // e.g., "Brown", "Dark", optional
  image     String // final PNG path
  price     Int? // null = free

  origin String? // e.g., "Asia", "Europe", "Bangladesh", "USA"
  gender AssetGender? // MALE, FEMALE, UNISEX

  avatarId String? // foreign key to parent avatar
  avatar   Avatar? @relation(fields: [avatarId], references: [id])

  createdAt DateTime @default(now())

  unlockedBy   ChildAsset[]
  Notification Notification[]
}

model Avatar {
  id    String @id @default(uuid())
  name  String
  image String // base avatar image (skeleton/face)

  origin String? // e.g., Asia, Europe, Bangladesh, USA
  gender AvatarGender

  createdAt DateTime @default(now())

  assets Asset[] // all assets belonging to this avatar
  usedBy ChildProfile[] // children using this avatar
}

model PushToken {
  id      String  @id @default(uuid())
  userId  String?
  childId String?

  token     String   @unique
  platform  Platform // ANDROID, IOS
  createdAt DateTime @default(now())

  user  User?         @relation(fields: [userId], references: [id])
  child ChildProfile? @relation(fields: [childId], references: [id])

  @@index([userId])
  @@index([childId])
}

enum Platform {
  ANDROID
  IOS
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  childId   String?
  action    String
  metadata  Json?
  createdAt DateTime @default(now())

  user  User?         @relation(fields: [userId], references: [id])
  child ChildProfile? @relation(fields: [childId], references: [id])
}
